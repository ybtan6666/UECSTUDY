// Minimal MVP: Paid Mathematics Q&A Marketplace for UEC Students
// Focus: Two-sided marketplace (students post, teachers answer)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL
// ============================================
model User {
  id            String    @id @default(cuid())
  uniqueId      String    @unique // UEC-XXXX format
  email         String    @unique
  name          String
  password      String
  role          String    @default("STUDENT") // "STUDENT", "TEACHER", "ADMIN"
  avatar        String?   // URL or emoji/initials
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  banned        Boolean   @default(false)

  // Relations
  questionsAsStudent    MathQuestion[] @relation("StudentQuestions")
  questionsAsTeacher    MathQuestion[] @relation("TeacherAnswers")
  bookingsAsStudent     Booking[]
  bookingsAsTeacher     Booking[] @relation("TeacherBookings")
  timeSlots             TimeSlot[]
  endorsementsGiven    Endorsement[] @relation("Endorser")
  endorsementsReceived  Endorsement[] @relation("EndorsedTeacher")
  followUpQuestions     FollowUpQuestion[] @relation("StudentFollowUps")
  followUpAnswers        FollowUpQuestion[] @relation("TeacherFollowUps")
  orderLogs             OrderLog[]
}

// ============================================
// FEATURE A: PAID QUESTION & ANSWER
// ============================================
model MathQuestion {
  id              String   @id @default(cuid())
  orderNumber     String?  @unique // Unique order number (ORD-000001, ORD-000002, etc.)
  
  // Question content (multiple formats)
  questionText    String?  // Text question
  questionImage   String?  // Image URL
  questionAudio   String?  // Audio URL
  questionVideo   String?  // Video URL
  
  // Student info
  studentId       String
  student         User     @relation("StudentQuestions", fields: [studentId], references: [id], onDelete: Cascade)
  
  // Teacher assignment (optional - can be open marketplace)
  teacherId       String?
  teacher         User?    @relation("TeacherAnswers", fields: [teacherId], references: [id], onDelete: SetNull)
  
  // Pricing & timing
  price           Float    // Student-set price (must meet platform minimum)
  expectedResponseHours Int // 6, 24, or 72 hours
  deadline        DateTime // Auto-calculated: createdAt + expectedResponseHours
  
  // Answer content (multiple formats)
  answerText      String?
  answerImage     String?
  answerAudio     String?
  answerVideo     String?
  
  // State machine
  status          String   @default("PENDING") // PENDING, ACCEPTED, ANSWERED, COMPLETED, CANCELLED, EXPIRED, REFUNDED
  acceptedAt      DateTime?
  answeredAt      DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  expiredAt       DateTime?
  refundedAt      DateTime?
  
  // Payment tracking
  paymentHeld     Boolean  @default(true) // Escrow
  paymentReleased Boolean  @default(false)
  platformFee    Float?   // Calculated on completion
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  followUps       FollowUpQuestion[]
  orderLogs       OrderLog[]
  
  @@index([orderNumber])
}

// Follow-up questions (treated as new paid sub-orders)
model FollowUpQuestion {
  id              String   @id @default(cuid())
  parentQuestionId String
  parentQuestion  MathQuestion @relation(fields: [parentQuestionId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         User     @relation("StudentFollowUps", fields: [studentId], references: [id], onDelete: Cascade)
  teacherId       String
  teacher         User     @relation("TeacherFollowUps", fields: [teacherId], references: [id], onDelete: Cascade)
  
  questionText    String?
  questionImage   String?
  questionAudio   String?
  questionVideo   String?
  
  answerText      String?
  answerImage     String?
  answerAudio     String?
  answerVideo     String?
  
  price           Float    // Additional payment for follow-up
  status          String   @default("PENDING") // Same states as MathQuestion
  acceptedAt      DateTime?
  answeredAt      DateTime?
  completedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// FEATURE B: TEACHER BOOKING / CONSULTATION
// ============================================
model TimeSlot {
  id              String   @id @default(cuid())
  teacherId       String
  teacher         User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  startTime       DateTime
  endTime         DateTime
  minPrice        Float    // Minimum price per slot
  maxStudents     Int      @default(1) // 1 = individual, >1 = group session
  minStudents     Int      @default(1) // For group sessions
  
  // Group session settings
  isGroupSession  Boolean  @default(false)
  meetingLink     String?  // Generated meeting link
  groupChatLink   String?  // Group chat link
  
  status          String   @default("AVAILABLE") // AVAILABLE, BOOKED, CANCELLED, COMPLETED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  bookings        Booking[]
}

model Booking {
  id              String   @id @default(cuid())
  orderNumber     String?  @unique // Unique order number (ORD-000001, ORD-000002, etc.)
  
  timeSlotId      String
  timeSlot        TimeSlot @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacherId       String
  teacher         User     @relation("TeacherBookings", fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Student requirements
  topic           String?  // Topic/questions
  expectations    String?  // revision / explanation / exam prep
  preferredFormat String?  // text / voice / video
  
  // Pricing
  price           Float    // Actual paid price (can be higher than minPrice)
  
  // State machine
  status          String   @default("PENDING") // PENDING, ACCEPTED, COMPLETED, CANCELLED, EXPIRED, REFUNDED
  acceptedAt      DateTime?
  cancelledAt     DateTime?
  cancelledBy     String?  // "STUDENT" or "TEACHER"
  cancellationReason String?
  completedAt     DateTime?
  expiredAt       DateTime?
  noShowAt        DateTime?
  refundedAt      DateTime?
  
  // Payment tracking
  paymentMethod   String?  // "BANK_TRANSFER", "E_WALLET", "CREDIT_CARD"
  paymentStatus   String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, REFUNDED
  paymentHeld     Boolean  @default(false) // Only true after payment completed
  paymentReleased Boolean  @default(false)
  platformFee     Float?
  paidAt          DateTime? // When payment was completed
  
  // Group session tracking
  isGroupBooking  Boolean  @default(false)
  groupId         String?  // For grouping multiple bookings
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  orderLogs       OrderLog[]
  
  @@unique([timeSlotId, studentId])
  @@index([teacherId])
  @@index([studentId])
  @@index([orderNumber])
}

// ============================================
// TEACHER VERIFICATION CODE
// ============================================
model VerificationCode {
  id          String   @id @default(cuid())
  code        String   @unique // 6-digit code
  used        Boolean  @default(false)
  usedBy      String?  // User ID who used this code
  usedAt      DateTime?
  createdAt   DateTime @default(now())
  expiresAt   DateTime? // Optional expiration

  @@index([code])
  @@index([used])
}

// ============================================
// TEACHER RANKING: ENDORSEMENTS
// ============================================
model Endorsement {
  id              String   @id @default(cuid())
  studentId       String   // Student who endorses
  student         User     @relation("Endorser", fields: [studentId], references: [id], onDelete: Cascade)
  teacherId       String   // Teacher being endorsed
  teacher         User     @relation("EndorsedTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Can only endorse after completed transaction
  questionId      String?  // Related completed question
  bookingId      String?  // Related completed booking
  
  createdAt       DateTime @default(now())
  
  @@unique([studentId, teacherId]) // One endorsement per student-teacher pair (lifetime)
  @@index([teacherId])
  @@index([studentId])
}

// ============================================
// ORDER STATE LOGGING
// ============================================
model OrderLog {
  id              String   @id @default(cuid())
  userId          String?  // Who triggered the change
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  questionId      String?
  question        MathQuestion? @relation(fields: [questionId], references: [id], onDelete: Cascade)
  bookingId      String?
  booking        Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  orderNumber     String?  // Order number at the time of this log entry (for filtering history by order number)
  
  fromStatus      String?
  toStatus        String
  action          String   // "CREATE", "ACCEPT", "ANSWER", "COMPLETE", "CANCEL", "EXPIRE", "REFUND", "REBOOK"
  metadata        String?  // JSON string for additional info
  
  createdAt       DateTime @default(now())
  
  @@index([orderNumber])
  @@index([bookingId, orderNumber])
  @@index([questionId, orderNumber])
}
